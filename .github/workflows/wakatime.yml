name: Waka Readme

# Impede execu√ß√µes duplicadas simult√¢neas
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  schedule:
    # Roda diariamente √†s 18:30 UTC
    - cron: '30 18 * * *'
  workflow_dispatch:

jobs:
  update-readme:
    name: Update Readme with Metrics
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Rodar WakaStats
        id: waka_job
        uses: anmol098/waka-readme-stats@master
        with:
          WAKATIME_API_KEY: ${{ secrets.WAKATIME_API_KEY }}
          GH_TOKEN: ${{ secrets.WAKATIME_TOKEN }}
          SHOW_LINES_OF_CODE: "true"
          SHOW_SHORT_INFO: "false"
          SHOW_PROFILE_VIEWS: "false"
          SHOW_TOTAL_CODE_TIME: "false"
          # Op√ß√µes extras para garantir estabilidade
          COMMIT_MESSAGE: "Updated WakaTime stats [skip ci]"
          SHOW_LOC_CHART: "false"

      - name: Notificar via Resend
        # S√≥ dispara se o passo anterior foi um sucesso absoluto e n√£o √© um push autom√°tico
        if: success() && steps.waka_job.outcome == 'success' && github.event_name != 'push'
        env:
          RESEND_KEY: ${{ secrets.RESEND_API_KEY }}
        run: |
          NOW=$(date +'%d/%m/%Y %H:%M')
          curl -s -X POST https://api.resend.com/emails \
            -H "Authorization: Bearer $RESEND_KEY" \
            -H "Content-Type: application/json" \
            -d '{
              "from": "notify@nemik.top",
              "to": "ser4ph4@proton.me",
              "subject": "üöÄ WakaTime: Perfil Atualizado!",
              "html": "<h3>‚úîÔ∏è README Atualizado!</h3><p>Suas estat√≠sticas de c√≥digo foram sincronizadas com sucesso.</p><p>üìÖ <strong>Data:</strong> '"$NOW"'</p><p>üí° <i>Dica: O tempo total de c√≥digo pode ser conferido diretamente no seu painel privado.</i></p><p>üîó <a href=\"https://wakatime.com/dashboard\">Acessar Dashboard do WakaTime</a></p>"
            }'
